
/**
 *
 * 输出第三方库依赖关系
 *
 * <p>在outputs查看输出结果
 * app/build/outputs/logs/dependencies-douyincn-27acffb3d1c.txt
 *
 * <p>在app内查看运行时依赖第三方库
 * 我->设置->Debug Test->依赖列表
 * @see https://wiki.bytedance.net/pages/viewpage.action?pageId=254713491
 *
 * 1、preBuild task前插入DependenceChecker task
 * 2、获取所有编译依赖，最终版本，以及版本选择理由
 * 3、写入buildConfigField
 * 4、运行时展示 {@link com.ss.android.ugc.aweme.setting.ui.TestDependenciesActivity}
 */
import java.util.regex.Matcher
import java.util.regex.Pattern

class DependenceBean {
    HashSet<String> allVersion = new HashSet<>()
    String selectVersion
    String selectionReason
}

class DependenceChecker {
    String flavor
    String buildType
}

final def EXT_NAME = "DependenceChecker"
final def PLUGIN_NAME = "DependenceCheckerTask"
project.extensions.create(EXT_NAME, DependenceChecker)
println("=============apply DependenceCheckerTask===============")

static def resolveDependencies(Map<String, DependenceBean> map, DependencyResult dr) {
    def depName = dr.requested.displayName
    if (dr != null && !depName.contains("project")) {
        String[] depSplit = depName.split(":")
        if (depSplit.length > 2) {
            def packageName = depSplit[0] + depSplit[1]
            def dependenceBean = map.get(packageName)
            if (dependenceBean == null) {
                dependenceBean = new DependenceBean()
                map.put(packageName, dependenceBean)
            }
            if (dr instanceof ResolvedDependencyResult) {
                dependenceBean.selectVersion = dr.selected.moduleVersion
                dependenceBean.selectionReason = dr.selected.selectionReason.description
            }
            dependenceBean.allVersion.add(depName)
        }
    }
    if (dr instanceof ResolvedDependencyResult) {
        dr.selected.dependencies.each { subDr ->
            resolveDependencies(map, subDr)
        }
    }
}

project.task(PLUGIN_NAME).doLast {
    Map<String, DependenceBean> depMap = new HashMap()
    String checkMode = "${BuildContext.flavor}${BuildContext.buildType}runtimeclasspath".toLowerCase()
    println EXT_NAME + " - " + checkMode
    project.configurations.each { Configuration conf ->
        if (conf.name.toLowerCase().contains(checkMode)) {
            conf.incoming.resolutionResult.root.dependencies.each { dr ->
                resolveDependencies(depMap, dr)
            }
            String dependenciesStr = ""
            depMap.each { k, v ->
                DependenceBean dependenceBean = v
                dependenceBean.allVersion.each { data ->
                    if (data.equals(dependenceBean.selectVersion)) {
                        data = "*" + data + "(" + dependenceBean.selectionReason + ")"
                    }
                    dependenciesStr += data + ","
                }
            }

            project.android.applicationVariants.all { variant ->
                android.productFlavors.all {
                    flavor ->
                        if (BuildContext.flavor.contains(flavor.name)) {
                            variant.buildConfigField 'String', 'DEPENDENCIES_COLLECT', "\"" + dependenciesStr + "\""

                            // 输出到outputs logs
                            new File("${project.buildDir.path}/outputs/logs/").mkdirs()
                            new File("${project.buildDir.path}/outputs/logs/dependencies-${BuildContext.flavor}-${GIT_SHA}.txt").withWriter('UTF-8') { writer ->
                                depMap.each { k, v ->
                                    DependenceBean dependenceBean = v
                                    dependenceBean.allVersion.each { data ->
                                        if (data.equals(dependenceBean.selectVersion)) {
                                            data = "*" + data + "(" + dependenceBean.selectionReason + ")"
                                        }
                                        writer.write(data + "\n")
                                    }
                                }
                            }
                        }
                }
            }
        }
    }
}
project.tasks.findByName('preBuild').dependsOn(project.tasks.findByName(PLUGIN_NAME))